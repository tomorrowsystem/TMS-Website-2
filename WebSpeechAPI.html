<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Speech API</title>
</head>
<body>
    <button id="start_button">Start</button>
    <button id="end_button">End</button>
    <div id="interim_transcript"></div>
    <div id="final_transcript"></div>
    <script>
        //https://developers.google.com/web/updates/2013/01/Voice-Driven-Web-Apps-Introduction-to-the-Web-Speech-API
        //https://developer.mozilla.org/en-US/docs/Web/API/Web_Speech_API#browser_compatibility
        //https://wicg.github.io/speech-api/
        //https://stackoverflow.com/questions/60501410/electron-not-working-with-web-speech-api
        //https://github.com/TalAter/annyang/blob/master/src/annyang.js
        //https://github.com/TalAter/annyang/blob/master/docs/FAQ.md#why-does-speech-recognition-repeatedly-starts-and-stops
        //https://github.com/csilva2810/webmplayer
        //https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Client-side_web_APIs/Video_and_audio_APIs
        //https://www.w3schools.com/tags/ref_av_dom.asp
        //https://howlerjs.com/
        var final_transcript = '';
        
        if (!('webkitSpeechRecognition' in window)) {
            alert('Web Speech API is no supported!');
        } else {
            var recognition = new webkitSpeechRecognition() || new SpeechRecognition();
            recognition.lang = 'it-IT';
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.maxAlternatives = 1;

            recognition.onstart = function() { console.log('onstart') }
            recognition.onspeechstart = function() { console.log('onspeechstart') }
            recognition.onresult = function(event) { 
                console.log('onresult', event);
                var interim_transcript = '';
                for (var i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        final_transcript += event.results[i][0].transcript;
                    } else {
                        interim_transcript += event.results[i][0].transcript;
                    }
                }
                document.getElementById('final_transcript').innerHTML = final_transcript;
                document.getElementById('interim_transcript').innerHTML = interim_transcript;
            }
            recognition.onerror = function(event) { console.log('onerror', event) }
            recognition.onspeechend = function() {
                console.log('onspeechend');
                download((new Date()).toDateString()+".txt", document.getElementById('final_transcript').innerHTML);
            }
            recognition.onend = function() { console.log('onend') }
        }

        document.getElementById('start_button').addEventListener('click', function(event) {
            recognition.start();
        })
        document.getElementById('end_button').addEventListener('click', function(event) {
            recognition.stop();
        })

        function download(filename, text) {
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);

            element.style.display = 'none';
            document.body.appendChild(element);

            element.click();

            document.body.removeChild(element);
        }

    </script>
</body>
</html>